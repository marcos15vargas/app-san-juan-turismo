---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Enviar Reporte Diario">
  <main class="max-w-4xl mx-auto py-10 px-4">
    <div id="loading" class="text-center py-10">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-900 mx-auto mb-4"></div>
      <p class="text-slate-500 font-medium">Cargando perfil de entidad...</p>
    </div>
    
    <div id="form-container" class="hidden bg-white p-8 rounded-2xl shadow-xl border border-slate-100">
      <div class="mb-8 border-b border-slate-100 pb-6">
        <h1 class="text-3xl font-bold text-slate-800" id="entidad-nombre">Cargar Reporte</h1>
        <div class="flex items-center gap-2 mt-2 text-slate-500">
          <span class="px-2 py-1 bg-slate-100 rounded text-xs font-bold uppercase tracking-wider" id="entidad-tipo">TIPO</span>
          <span class="text-sm" id="entidad-departamento">Departamento</span>
        </div>
      </div>

      <form id="dynamic-form" class="space-y-10">
        
        <div id="section-hotel" class="hidden space-y-8">
          <div class="space-y-4">
            <h3 class="text-lg font-bold text-blue-900 flex items-center gap-2">Estado de Ocupación</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
              <div class="space-y-1">
                <label class="text-sm font-semibold text-slate-700">Hab. Totales (Oficial)</label>
                <input 
                  type="number" 
                  name="total_habitaciones" 
                  id="field-total-habitaciones"
                  readonly 
                  class="w-full p-3 border rounded-xl bg-slate-100 text-slate-500 cursor-not-allowed outline-none" 
                  placeholder="0"
                >
              </div>
              <div class="space-y-1">
                <label class="text-sm font-semibold text-slate-700">Hab. Ocupadas</label>
                <input type="number" name="habitaciones_ocupadas" min="0" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="0">
              </div>
              <div class="space-y-1">
                <label class="text-sm font-semibold text-slate-700">Huéspedes</label>
                <input type="number" name="total_huespedes" min="0" class="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="0">
              </div>
            </div>
          </div>

          <div class="space-y-4">
            <h3 class="text-lg font-bold text-blue-900">Origen y Reservas</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <input type="number" name="origen_local" min="0" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Origen Local">
              <input type="number" name="origen_nacional" min="0" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Origen Nacional">
              <input type="number" name="origen_internacional" min="0" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Origen Internacional">
              <input type="number" name="reserva_online" min="0" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Reserva Online">
              <input type="number" name="reserva_telefono" min="0" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Reserva Teléfono">
              <input type="number" name="reserva_presencial" min="0" class="p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" placeholder="Reserva Presencial">
            </div>
          </div>
        </div>

        <div id="section-museo" class="hidden space-y-8">
          <div class="space-y-4">
            <h3 class="text-lg font-bold text-orange-700 flex items-center gap-2">Control de Afluencia</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="md:col-span-2 space-y-1">
                <label class="text-sm font-bold text-slate-700">Total de Visitantes del Día</label>
                <input type="number" min="0" name="total_visitantes" class="w-full py-2 pl-3 border-2 rounded-xl outline-none focus:border-orange-500 text-xl font-bold" placeholder="0">
              </div>
              
              <div class="space-y-1">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Visitantes Locales (San Juan)</label>
                <input type="number" min="0" name="visitantes_locales" class="w-full py-2 pl-3 border rounded-xl focus:ring-2 focus:ring-orange-500 outline-none" placeholder="0">
              </div>
              
              <div class="space-y-1">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Visitantes Nacionales (Argentina)</label>
                <input type="number" min="0" name="visitantes_nacionales" class="w-full py-2 pl-3 border rounded-xl focus:ring-2 focus:ring-orange-500 outline-none" placeholder="0">
              </div>

              <div class="space-y-1 md:col-span-2">
                <label class="text-xs font-bold text-slate-500 uppercase tracking-wider">Visitantes Internacionales</label>
                <input type="number" min="0" name="visitantes_internacionales" class="w-full py-2 pl-3 border rounded-xl focus:ring-2 focus:ring-orange-500 outline-none" placeholder="0">
              </div>
            </div>
          </div>
        </div>

        <button type="submit" class="w-full  bg-slate-900 text-white py-5 rounded-2xl font-bold shadow-lg hover:bg-black transition-all flex items-center justify-center gap-3">
          ENVIAR REPORTE OFICIAL
        </button>
      </form>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  const form = document.getElementById('dynamic-form') as HTMLFormElement;
  let userProfile: any = null;

  async function init() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = '/'; return; }

    const { data: perfil, error } = await supabase
      .from('perfiles')
      .select('*, entidades(*)')
      .eq('id', user.id)
      .single();

    if (error || !perfil?.entidades) {
      alert("Error: Tu usuario no tiene una entidad vinculada.");
      return;
    }

    userProfile = perfil;

    document.getElementById('loading')?.classList.add('hidden');
    document.getElementById('form-container')?.classList.remove('hidden');
    
    document.getElementById('entidad-nombre')!.textContent = perfil.entidades.nombre;
    document.getElementById('entidad-tipo')!.textContent = perfil.entidades.tipo;
    document.getElementById('entidad-departamento')!.textContent = perfil.entidades.departamento;

    if (perfil.entidades.tipo === 'hotel') {
      document.getElementById('section-hotel')?.classList.remove('hidden');
      
      // AUTO-LLENADO DE HABITACIONES TOTALES (Dato Fijo)
      const inputHabTotales = document.getElementById('field-total-habitaciones') as HTMLInputElement;
      if (inputHabTotales) {
        inputHabTotales.value = perfil.entidades.capacidad_maxima;
      }

    } else if (perfil.entidades.tipo === 'museo') {
      document.getElementById('section-museo')?.classList.remove('hidden');
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    
    const payload: any = {
      entidad_id: userProfile.entidad_id,
      creado_por: userProfile.id
    };

    formData.forEach((value, key) => {
      if (value !== "") {
        payload[key] = key === 'estadia_promedio' ? parseFloat(value.toString()) : parseInt(value.toString());
      }
    });

    const table = userProfile.entidades.tipo === 'hotel' ? 'reportes_hoteleria' : 'reportes_museos';

    const { error } = await supabase.from(table).insert(payload);

    if (error) {
      alert("Error al enviar: " + error.message);
    } else {
      alert("Reporte guardado exitosamente.");
      // No reseteamos el valor fijo de total_habitaciones al limpiar el form
      const habs = (document.getElementById('field-total-habitaciones') as HTMLInputElement)?.value;
      form.reset();
      if (habs) (document.getElementById('field-total-habitaciones') as HTMLInputElement).value = habs;
    }
  });

  init();
</script>