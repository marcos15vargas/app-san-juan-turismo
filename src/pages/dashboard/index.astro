---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Panel de Control Gubernamental">
  <main class="max-w-7xl mx-auto px-4 py-8">
    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-slate-900 tracking-tight">Monitor Turístico Provincial</h1>
        <p class="text-slate-500">San Juan - Gestión Basada en Datos Verificados</p>
      </div>
      
      <div class="flex flex-col sm:flex-row items-center gap-4">
        <div id="admin-actions" class="hidden">
          <a 
            href="/dashboard/gestion" 
            class="flex items-center gap-2 bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium transition-all shadow-sm border border-slate-700 text-sm"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            Gestionar Entidades
          </a>
        </div>

        <div class="bg-white p-2 rounded-xl shadow-sm border flex gap-2">
          <button id="tab-hoteles" class="px-4 py-2 rounded-lg bg-blue-900 text-white font-medium transition-all">Hotelería</button>
          <button id="tab-museos" class="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 transition-all">Cultura y Museos</button>
        </div>
      </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Huéspedes Totales</span>
        <div class="text-3xl font-bold text-slate-900 mt-1" id="stat-total-huespedes">0</div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Ocupación Promedio</span>
        <div class="text-3xl font-bold text-blue-600 mt-1" id="stat-avg-ocupacion">0%</div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Visitantes Museos</span>
        <div class="text-3xl font-bold text-orange-600 mt-1" id="stat-total-visitantes">0</div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Estadía Promedio</span>
        <div class="text-3xl font-bold text-slate-900 mt-1" id="stat-avg-estadia">0 nts</div>
      </div>
    </div>

    <section id="content-hoteles" class="space-y-8">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Ocupación por Departamento (Hotelería)</h3>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="text-slate-400 text-sm uppercase">
                <th class="pb-4 font-medium">Departamento</th>
                <th class="pb-4 font-medium">Hab. Totales</th>
                <th class="pb-4 font-medium">Hab. Ocupadas</th>
                <th class="pb-4 font-medium text-right">% Ocupación</th>
              </tr>
            </thead>
            <tbody id="table-hoteles" class="text-slate-700">
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="content-museos" class="hidden space-y-8">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
        <h3 class="text-lg font-bold mb-4">Afluencia en Sitios Culturales</h3>
        <div id="list-museos" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        </div>
      </div>
    </section>
  </main>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';

  // Manejo de Tabs
  const btnHoteles = document.getElementById('tab-hoteles');
  const btnMuseos = document.getElementById('tab-museos');
  const secHoteles = document.getElementById('content-hoteles');
  const secMuseos = document.getElementById('content-museos');

  btnHoteles?.addEventListener('click', () => {
    secHoteles?.classList.remove('hidden');
    secMuseos?.classList.add('hidden');
    btnHoteles.className = "px-4 py-2 rounded-lg bg-blue-900 text-white font-medium transition-all";
    btnMuseos!.className = "px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 transition-all";
  });

  btnMuseos?.addEventListener('click', () => {
    secMuseos?.classList.remove('hidden');
    secHoteles?.classList.add('hidden');
    btnMuseos.className = "px-4 py-2 rounded-lg bg-orange-600 text-white font-medium transition-all";
    btnHoteles!.className = "px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100 transition-all";
  });

  // FUNCIÓN PARA VERIFICAR ROL Y MOSTRAR BOTÓN DE GESTIÓN
  async function checkAdminAccess() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data: perfil } = await supabase
      .from('perfiles')
      .select('rol')
      .eq('id', user.id)
      .single();

    if (perfil?.rol === 'admin_gobierno') {
      const adminActions = document.getElementById('admin-actions');
      adminActions?.classList.remove('hidden');
    }
  }

  async function fetchData() {
    const { data: hotelData } = await supabase
      .from('reportes_hoteleria')
      .select('*, entidades(nombre, departamento)');

    const { data: museoData } = await supabase
      .from('reportes_museos')
      .select('*, entidades(nombre, departamento)');

    if (hotelData) renderHoteles(hotelData);
    if (museoData) renderMuseos(museoData);
  }

  function renderHoteles(data: any[]) {
    const table = document.getElementById('table-hoteles');
    let totalHuespedes = 0;
    let totalHab = 0;
    let totalOcu = 0;
    let sumaEstadia = 0;

    table!.innerHTML = data.map((r: any) => {
      totalHuespedes += r.total_huespedes || 0;
      totalHab += r.total_habitaciones || 0;
      totalOcu += r.habitaciones_ocupadas || 0;
      sumaEstadia += r.estadia_promedio || 0;

      const porc = r.total_habitaciones > 0 ? ((r.habitaciones_ocupadas / r.total_habitaciones) * 100).toFixed(1) : "0.0";

      return `
        <tr class="border-t border-slate-50">
          <td class="py-4 font-semibold">${r.entidades.departamento} <br><span class="text-xs font-normal text-slate-400">${r.entidades.nombre}</span></td>
          <td class="py-4">${r.total_habitaciones || '-'}</td>
          <td class="py-4">${r.habitaciones_ocupadas || '-'}</td>
          <td class="py-4 text-right">
            <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-bold">${porc}%</span>
          </td>
        </tr>
      `;
    }).join('');

    document.getElementById('stat-total-huespedes')!.textContent = totalHuespedes.toLocaleString();
    document.getElementById('stat-avg-ocupacion')!.textContent = `${totalHab > 0 ? ((totalOcu / totalHab) * 100).toFixed(1) : 0}%`;
    document.getElementById('stat-avg-estadia')!.textContent = `${(sumaEstadia / (data.length || 1)).toFixed(1)} nts`;
  }

  function renderMuseos(data: any[]) {
    const list = document.getElementById('list-museos');
    let totalVis = 0;

    list!.innerHTML = data.map((r: any) => {
      totalVis += r.total_visitantes || 0;
      return `
        <div class="p-4 border border-slate-100 rounded-xl bg-slate-50">
          <div class="text-sm text-slate-500">${r.entidades.nombre}</div>
          <div class="text-xl font-bold text-slate-900">${r.total_visitantes} visitantes</div>
          <div class="text-xs text-orange-600 mt-1 font-medium">${r.visitantes_internacionales || 0} extranjeros</div>
        </div>
      `;
    }).join('');

    document.getElementById('stat-total-visitantes')!.textContent = totalVis.toLocaleString();
  }

  // Ejecución inicial
  checkAdminAccess();
  fetchData();
</script>