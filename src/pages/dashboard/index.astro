---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Panel de Control">
  <main class="max-w-6xl mx-auto py-10 px-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-slate-900" id="welcome-title">Cargando Panel...</h1>
        <p class="text-slate-500" id="welcome-subtitle">Bienvenido al sistema de estadísticas turísticas</p>
      </div>
      <div class="flex gap-3" id="action-buttons"></div>
    </div>

    <div id="admin-charts" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
      <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
          <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
          Tendencia de Huéspedes
        </h3>
        <div class="h-[300px] w-full">
          <canvas id="chart-hoteles"></canvas>
        </div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
          <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
          Distribución de Visitantes
        </h3>
        <div class="h-[300px] w-full">
          <canvas id="chart-museos"></canvas>
        </div>
      </div>
    </div>

    <div id="admin-filters" class="hidden mb-8 flex gap-4">
        <button class="filter-btn active bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold" data-filter="todos">Todos</button>
        <button class="filter-btn bg-white text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border" data-filter="hotel">Hoteles</button>
        <button class="filter-btn bg-white text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border" data-filter="museo">Museos</button>
    </div>

    <div class="grid grid-cols-1 gap-8">
      <section id="container-hoteles" class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
        <div class="p-6 border-b border-slate-100 bg-blue-50/50">
          <h2 class="font-bold text-blue-900">Reportes de Hotelería</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 uppercase text-[10px]">
              <tr><th class="px-6 py-4">Fecha</th><th class="px-6 py-4">Entidad</th><th class="px-6 py-4">Huéspedes</th><th class="px-6 py-4 text-right">Acciones</th></tr>
            </thead>
            <tbody id="tabla-hoteles" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </section>

      <section id="container-museos" class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
        <div class="p-6 border-b border-slate-100 bg-orange-50/50">
          <h2 class="font-bold text-orange-900">Reportes de Museos</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 uppercase text-[10px]">
              <tr><th class="px-6 py-4">Fecha</th><th class="px-6 py-4">Entidad</th><th class="px-6 py-4">Total</th><th class="px-6 py-4 text-right">Acciones</th></tr>
            </thead>
            <tbody id="tabla-museos" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';
  import Chart from 'chart.js/auto';
  import { jsPDF } from 'jspdf';
  import autoTable from 'jspdf-autotable';

  let userProfile: any = null;
  let chartHoteles: any = null;
  let chartMuseos: any = null;
  let currentDataHoteles: any[] = [];
  let currentDataMuseos: any[] = [];

  async function initDashboard() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = '/'; return; }

    const { data: perfil } = await supabase.from('perfiles').select('*, entidades(*)').eq('id', user.id).single();
    userProfile = perfil;

    if (perfil.rol === 'admin_gobierno') {
      document.getElementById('welcome-title')!.textContent = "Panel de Gobierno";
      document.getElementById('admin-filters')?.classList.remove('hidden');
      document.getElementById('admin-charts')?.classList.remove('hidden');
      
      const actions = document.getElementById('action-buttons');
      if (actions) {
        actions.innerHTML = `<button id="btn-pdf" class="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-black transition-all">DESCARGAR INFORME COMPLETO</button>`;
        document.getElementById('btn-pdf')?.addEventListener('click', exportarPDFPro);
      }
      cargarTodo();
    } else {
      document.getElementById('welcome-title')!.textContent = perfil.entidades.nombre;
      perfil.entidades.tipo === 'hotel' ? cargarDatosHotel(perfil.entidad_id) : cargarDatosMuseo(perfil.entidad_id);
    }
  }

  function renderChartHoteles(data: any[]) {
    const ctx = document.getElementById('chart-hoteles') as HTMLCanvasElement;
    if (chartHoteles) chartHoteles.destroy();
    // Forzamos mayor resolución en el canvas
    ctx.width = ctx.parentElement!.offsetWidth * 2;
    ctx.height = 300 * 2;

    chartHoteles = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [...data].reverse().map(r => new Date(r.fecha_reporte).toLocaleDateString()),
        datasets: [{ label: 'Huéspedes', data: [...data].reverse().map(r => r.total_huespedes), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }]
      },
      options: { maintainAspectRatio: false, devicePixelRatio: 2 }
    });
  }

  function renderChartMuseos(data: any[]) {
    const ctx = document.getElementById('chart-museos') as HTMLCanvasElement;
    if (chartMuseos) chartMuseos.destroy();
    ctx.width = ctx.parentElement!.offsetWidth * 2;
    ctx.height = 300 * 2;

    const t = data.reduce((acc, c) => ({ l: acc.l + (c.visitantes_locales || 0), n: acc.n + (c.visitantes_nacionales || 0) }), { l: 0, n: 0 });
    chartMuseos = new Chart(ctx, {
      type: 'doughnut',
      data: { labels: ['Locales', 'Nacionales'], datasets: [{ data: [t.l, t.n], backgroundColor: ['#f97316', '#fbbf24'] }] },
      options: { maintainAspectRatio: false, devicePixelRatio: 2 }
    });
  }

  async function exportarPDFPro() {
    const btn = document.getElementById('btn-pdf') as HTMLButtonElement;
    btn.textContent = "Procesando...";
    btn.disabled = true;

    try {
      const doc = new jsPDF('p', 'mm', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();

      // Página 1: Hotelería
      doc.setFillColor(30, 41, 59);
      doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.text("Informe de Gestión Turística", 14, 22);
      doc.setFontSize(10);
      doc.text(`Sector: Hotelería | Fecha: ${new Date().toLocaleDateString()}`, 14, 30);

      const canvasHoteles = document.getElementById('chart-hoteles') as HTMLCanvasElement;
      const imgHoteles = canvasHoteles.toDataURL('image/png', 1.0);
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(14);
      doc.text("Tendencia de Ocupación", 14, 45);
      doc.addImage(imgHoteles, 'PNG', 14, 50, 180, 70);

      autoTable(doc, {
        startY: 125,
        head: [['Fecha', 'Entidad', 'Huéspedes']],
        body: currentDataHoteles.map(r => [new Date(r.fecha_reporte).toLocaleDateString(), r.entidades.nombre, r.total_huespedes]),
        headStyles: { fillColor: [59, 130, 246] },
        theme: 'striped'
      });

      // Página 2: Museos
      doc.addPage();
      doc.setFillColor(30, 41, 59);
      doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setTextColor(255, 255, 255);
      doc.setFontSize(20);
      doc.text("Informe de Gestión Turística", 14, 22);
      doc.setFontSize(10);
      doc.text(`Sector: Cultura y Museos | Fecha: ${new Date().toLocaleDateString()}`, 14, 30);

      const canvasMuseos = document.getElementById('chart-museos') as HTMLCanvasElement;
      const imgMuseos = canvasMuseos.toDataURL('image/png', 1.0);
      doc.setTextColor(30, 41, 59);
      doc.setFontSize(14);
      doc.text("Distribución de Visitantes", 14, 45);
      doc.addImage(imgMuseos, 'PNG', 50, 50, 100, 80);

      autoTable(doc, {
        startY: 135,
        head: [['Fecha', 'Museo', 'Total Visitantes']],
        body: currentDataMuseos.map(r => [new Date(r.fecha_reporte).toLocaleDateString(), r.entidades.nombre, r.total_visitantes]),
        headStyles: { fillColor: [249, 115, 22] },
        theme: 'striped'
      });

      doc.save("Reporte_Turismo_Oficial.pdf");
    } catch (err) {
      console.error(err);
      alert("Error al generar PDF");
    } finally {
      btn.textContent = "DESCARGAR INFORME COMPLETO";
      btn.disabled = false;
    }
  }

  async function cargarDatosHotel(id = null) {
    let q = supabase.from('reportes_hoteleria').select('*, entidades(nombre)').order('fecha_reporte', { ascending: false });
    if (id) q = q.eq('entidad_id', id);
    const { data } = await q;
    if (data) {
      currentDataHoteles = data;
      document.getElementById('tabla-hoteles')!.innerHTML = data.map(r => `<tr class="hover:bg-slate-50"><td class="px-6 py-4">${new Date(r.fecha_reporte).toLocaleDateString()}</td><td class="px-6 py-4 font-medium">${r.entidades.nombre}</td><td class="px-6 py-4">${r.total_huespedes}</td><td class="px-6 py-4 text-right"><button onclick="confirmarEliminacion('${r.id}', 'reportes_hoteleria')" class="text-red-500 font-bold">Borrar</button></td></tr>`).join('');
      if (userProfile.rol === 'admin_gobierno') renderChartHoteles(data);
    }
  }

  async function cargarDatosMuseo(id = null) {
    let q = supabase.from('reportes_museos').select('*, entidades(nombre)').order('fecha_reporte', { ascending: false });
    if (id) q = q.eq('entidad_id', id);
    const { data } = await q;
    if (data) {
      currentDataMuseos = data;
      document.getElementById('tabla-museos')!.innerHTML = data.map(r => `<tr class="hover:bg-slate-50"><td class="px-6 py-4">${new Date(r.fecha_reporte).toLocaleDateString()}</td><td class="px-6 py-4 font-medium">${r.entidades.nombre}</td><td class="px-6 py-4">${r.total_visitantes}</td><td class="px-6 py-4 text-right"><button onclick="confirmarEliminacion('${r.id}', 'reportes_museos')" class="text-red-500 font-bold">Borrar</button></td></tr>`).join('');
      if (userProfile.rol === 'admin_gobierno') renderChartMuseos(data);
    }
  }

  function cargarTodo() { cargarDatosHotel(); cargarDatosMuseo(); }
  initDashboard();
</script>