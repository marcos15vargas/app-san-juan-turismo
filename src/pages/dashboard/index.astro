---
import Layout from '../../layouts/Layout.astro';
import MapaEstadistico from '../../components/dashboard/MapaEstadistico.astro';
import GraficosAdmin from '../../components/dashboard/GraficosAdmin.astro';
import TablasReportes from '../../components/dashboard/TablasReportes.astro';
---

<Layout title="Panel de Control">
  <main class="max-w-6xl mx-auto py-10 px-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-slate-900" id="welcome-title">Cargando Panel...</h1>
        <p class="text-slate-500" id="welcome-subtitle">Bienvenido al sistema de estadísticas turísticas</p>
      </div>
      <div id="action-buttons" class="flex flex-wrap gap-3"></div>
    </div>

    <MapaEstadistico />
    <GraficosAdmin />
    <TablasReportes />

  </main>
</Layout>

<script>
  import * as api from '../../lib/dashboard/dataService';
  import * as charts from '../../lib/dashboard/chartLogic';
  import * as map from '../../lib/dashboard/mapLogic';
  import { exportarPDF } from '../../lib/dashboard/pdfService';

  // Variables de estado local para manejar los datos en esta página
  let dataH: any[] = [];
  let dataM: any[] = [];

  async function init() {
    try {
      const perfil = await api.getProfile();
      
      if (!perfil) {
        window.location.href = '/';
        return;
      }

      const actions = document.getElementById('action-buttons');

      if (perfil.rol === 'admin_gobierno') {
        // 1. Configurar UI de Admin
        document.getElementById('welcome-title')!.textContent = "Panel de Gobierno";
        document.getElementById('admin-filters')?.classList.remove('hidden');
        document.getElementById('admin-charts')?.classList.remove('hidden');
        document.getElementById('map-section')?.classList.remove('hidden');
        
        if (actions) {
          actions.innerHTML = `
            <a href="/dashboard/gestion" class="bg-white text-slate-700 border border-slate-200 px-5 py-2.5 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all text-sm">GESTIONAR ENTIDADES</a>
            <button id="btn-pdf" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-black transition-all text-sm">DESCARGAR PDF</button>
          `;
        }

        // 2. Cargar Datos desde el servicio
        dataH = await api.fetchHoteles();
        dataM = await api.fetchMuseos();
        
        // 3. Renderizar Visualizaciones (Mapa y Gráficos)
        await map.initMap(dataH, dataM);
        charts.renderChartHoteles(dataH);
        charts.renderChartMuseos(dataM);
        charts.renderChartIntegrado(dataH, dataM);

        // 4. Renderizar Tablas
        actualizarTablas(dataH, dataM);
        
        // 5. Configurar Eventos
        setupEventListeners();

      } else {
        // Lógica para usuarios de entidades (Hoteles/Museos)
        document.getElementById('welcome-title')!.textContent = perfil.entidades.nombre;
        if (actions) {
          actions.innerHTML = `<a href="/dashboard/reportar" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold"> + NUEVO REPORTE</a>`;
        }

        if (perfil.entidades.tipo === 'hotel') {
          dataH = await api.fetchHoteles(perfil.entidad_id);
          actualizarTablas(dataH, []);
        } else {
          dataM = await api.fetchMuseos(perfil.entidad_id);
          actualizarTablas([], dataM);
        }
      }
    } catch (error) {
      console.error("Error al inicializar el Dashboard:", error);
    }
  }

  // Función para llenar las tablas HTML
  function actualizarTablas(hoteles: any[], museos: any[]) {
    const tablaHoteles = document.getElementById('tabla-hoteles');
    const tablaMuseos = document.getElementById('tabla-museos');

    if (tablaHoteles) {
      tablaHoteles.innerHTML = hoteles.map(r => `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
          <td class="px-4 py-4 text-xs text-slate-500">${new Date(r.fecha_reporte).toLocaleDateString()}</td>
          <td class="px-4 py-4 font-medium text-slate-700">${r.entidades?.nombre || 'N/A'}</td>
          <td class="px-4 py-4 font-bold text-blue-600">${r.total_huespedes || 0}</td>
          <td class="px-4 py-4 text-slate-600">${r.habitaciones_ocupadas || 0}</td>
          <td class="px-4 py-4 text-slate-600">${r.origen_nacional || 0}</td>
          <td class="px-4 py-4 text-slate-600">${r.origen_internacional || 0}</td>
          <td class="px-4 py-4 text-right">
            <button data-id="${r.id}" data-type="reportes_hoteleria" class="delete-btn text-red-500 hover:text-red-700 font-bold text-xs">Borrar</button>
          </td>
        </tr>`).join('');
    }

    if (tablaMuseos) {
      tablaMuseos.innerHTML = museos.map(r => `
        <tr class="hover:bg-slate-50 border-b border-slate-100">
          <td class="px-4 py-4 text-xs text-slate-500">${new Date(r.fecha_reporte).toLocaleDateString()}</td>
          <td class="px-4 py-4 font-medium text-slate-700">${r.entidades?.nombre || 'N/A'}</td>
          <td class="px-4 py-4 text-slate-600">${r.visitantes_locales || 0}</td>
          <td class="px-4 py-4 text-slate-600">${r.visitantes_nacionales || 0}</td>
          <td class="px-4 py-4 text-slate-600">${r.visitantes_internacionales || 0}</td>
          <td class="px-4 py-4 font-bold text-orange-600">${r.total_visitantes || 0}</td>
          <td class="px-4 py-4 text-right">
            <button data-id="${r.id}" data-type="reportes_museos" class="delete-btn text-red-500 hover:text-red-700 font-bold text-xs">Borrar</button>
          </td>
        </tr>`).join('');
    }

    // Listener para botones de borrado (Delegación de eventos)
    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const target = e.target as HTMLElement;
        const id = target.dataset.id;
        const type = target.dataset.type;
        if (id && type && confirm("¿Estás seguro de que deseas eliminar este registro?")) {
          await api.eliminarRegistro(id, type);
          init(); // Recargar datos y refrescar UI
        }
      });
    });
  }

  function setupEventListeners() {
    // PDF
    document.getElementById('btn-pdf')?.addEventListener('click', () => exportarPDF(dataH, dataM));
    
    // Filtro por mes
    document.getElementById('filtro-mes')?.addEventListener('change', (e) => {
      const mes = (e.target as HTMLSelectElement).value;
      charts.renderChartIntegrado(dataH, dataM, mes);
    });

    // Filtros de vista (Hoteles/Museos)
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.replace('bg-slate-900', 'bg-white'));
        btn.classList.replace('bg-white', 'bg-slate-900');
        const filter = btn.getAttribute('data-filter');
        document.getElementById('container-hoteles')?.classList.toggle('hidden', filter === 'museo');
        document.getElementById('container-museos')?.classList.toggle('hidden', filter === 'hotel');
      });
    });
  }

  init();
</script>