---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Panel de Control">
  <main class="max-w-6xl mx-auto py-10 px-4">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold text-slate-900" id="welcome-title">Cargando Panel...</h1>
        <p class="text-slate-500" id="welcome-subtitle">Bienvenido al sistema de estadísticas turísticas</p>
      </div>
      <div id="action-buttons" class="flex flex-wrap gap-3"></div>
    </div>

    <div id="admin-charts" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
      <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
          <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
          Tendencia de Huéspedes
        </h3>
        <div class="h-[300px] w-full">
          <canvas id="chart-hoteles"></canvas>
        </div>
      </div>
      <div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-200">
        <h3 class="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
          <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
          Distribución de Visitantes
        </h3>
        <div class="h-[300px] w-full">
          <canvas id="chart-museos"></canvas>
        </div>
      </div>
    </div>

    <div id="admin-filters" class="hidden mb-8 flex gap-4">
        <button class="filter-btn active bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold" data-filter="todos">Todos</button>
        <button class="filter-btn bg-white text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border" data-filter="hotel">Hoteles</button>
        <button class="filter-btn bg-white text-slate-600 px-4 py-2 rounded-lg text-sm font-bold border" data-filter="museo">Museos</button>
    </div>

    <div class="grid grid-cols-1 gap-8">
      <section id="container-hoteles" class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
        <div class="p-6 border-b border-slate-100 bg-blue-50/50">
          <h2 class="font-bold text-blue-900">Reportes de Hotelería (Detalle Completo)</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 uppercase text-[10px]">
              <tr>
                <th class="px-4 py-4">Fecha</th>
                <th class="px-4 py-4">Entidad</th>
                <th class="px-4 py-4">Huéspedes</th>
                <th class="px-4 py-4">Hab. Ocupadas</th>
                <th class="px-4 py-4">Hab. Disponibles</th>
                <th class="px-4 py-4 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-hoteles" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </section>

      <section id="container-museos" class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
        <div class="p-6 border-b border-slate-100 bg-orange-50/50">
          <h2 class="font-bold text-orange-900">Reportes de Museos (Detalle Completo)</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left text-sm">
            <thead class="bg-slate-50 text-slate-500 uppercase text-[10px]">
              <tr>
                <th class="px-4 py-4">Fecha</th>
                <th class="px-4 py-4">Entidad</th>
                <th class="px-4 py-4">Locales</th>
                <th class="px-4 py-4">Nacionales</th>
                <th class="px-4 py-4">Extranjeros</th>
                <th class="px-4 py-4">Total</th>
                <th class="px-4 py-4 text-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="tabla-museos" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </section>
    </div>
  </main>
</Layout>

<script>
  import { supabase } from '../../lib/supabase';
  import Chart from 'chart.js/auto';
  import { jsPDF } from 'jspdf';
  import autoTable from 'jspdf-autotable';

  let userProfile: any = null;
  let chartHoteles: any = null;
  let chartMuseos: any = null;
  let currentDataHoteles: any[] = [];
  let currentDataMuseos: any[] = [];

  // Función de ayuda para manejar nulos
  const clean = (val: any) => val ?? 0;

  async function initDashboard() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { window.location.href = '/'; return; }
    const { data: perfil } = await supabase.from('perfiles').select('*, entidades(*)').eq('id', user.id).single();
    userProfile = perfil;
    const actions = document.getElementById('action-buttons');

    if (perfil.rol === 'admin_gobierno') {
      document.getElementById('welcome-title')!.textContent = "Panel de Gobierno";
      document.getElementById('admin-filters')?.classList.remove('hidden');
      document.getElementById('admin-charts')?.classList.remove('hidden');
      if (actions) {
        actions.innerHTML = `
          <a href="/dashboard/gestion" class="bg-white text-slate-700 border border-slate-200 px-5 py-2.5 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all flex items-center gap-2 text-sm">GESTIONAR ENTIDADES</a>
          <button id="btn-pdf" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:bg-black transition-all flex items-center gap-2 text-sm">DESCARGAR INFORME PDF</button>
        `;
        document.getElementById('btn-pdf')?.addEventListener('click', exportarPDFPro);
      }
      cargarTodo();
    } else {
      document.getElementById('welcome-title')!.textContent = perfil.entidades.nombre;
      if (actions) {
        actions.innerHTML = `<a href="/dashboard/reportar" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all">+ NUEVO REPORTE</a>`;
      }
      perfil.entidades.tipo === 'hotel' ? cargarDatosHotel(perfil.entidad_id) : cargarDatosMuseo(perfil.entidad_id);
    }
  }

  function renderChartHoteles(data: any[]) {
    const ctx = document.getElementById('chart-hoteles') as HTMLCanvasElement;
    if (chartHoteles) chartHoteles.destroy();
    chartHoteles = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [...data].reverse().map(r => new Date(r.fecha_reporte).toLocaleDateString()),
        datasets: [{ label: 'Huéspedes', data: [...data].reverse().map(r => clean(r.total_huespedes)), borderColor: '#3b82f6', tension: 0.4, fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)' }]
      },
      options: { maintainAspectRatio: false, devicePixelRatio: 2, animation: false }
    });
  }

  function renderChartMuseos(data: any[]) {
    const ctx = document.getElementById('chart-museos') as HTMLCanvasElement;
    if (chartMuseos) chartMuseos.destroy();
    const t = data.reduce((acc, c) => ({ 
        l: acc.l + clean(c.visitantes_locales), 
        n: acc.n + clean(c.visitantes_nacionales),
        e: acc.e + clean(c.visitantes_internacionales)
    }), { l: 0, n: 0, e: 0 });
    chartMuseos = new Chart(ctx, {
      type: 'doughnut',
      data: { 
        labels: ['Locales', 'Nacionales', 'Internacionales'], 
        datasets: [{ data: [t.l, t.n, t.e], backgroundColor: ['#f97316', '#fbbf24', '#10b981'] }] 
      },
      options: { maintainAspectRatio: false, devicePixelRatio: 2, animation: false }
    });
  }

  async function exportarPDFPro() {
    const btn = document.getElementById('btn-pdf') as HTMLButtonElement;
    btn.textContent = "Generando...";
    btn.disabled = true;
    try {
      const doc = new jsPDF('p', 'mm', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();

      // Pág 1: Hotelería
      doc.setFillColor(30, 41, 59); doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setTextColor(255, 255, 255); doc.setFontSize(20); doc.text("Informe de Gestión Turística", 14, 22);
      const canvasHoteles = document.getElementById('chart-hoteles') as HTMLCanvasElement;
      doc.addImage(canvasHoteles.toDataURL('image/png'), 'PNG', 14, 45, 180, 70);

      autoTable(doc, {
        startY: 120,
        head: [['Fecha', 'Entidad', 'Huéspedes', 'Hab. Ocup', 'Hab. Disp']],
        body: currentDataHoteles.map(r => [new Date(r.fecha_reporte).toLocaleDateString(), r.entidades.nombre, clean(r.total_huespedes), clean(r.habitaciones_ocupadas), clean(r.habitaciones_disponibles)]),
        headStyles: { fillColor: [59, 130, 246] }
      });

      // Pág 2: Museos
      doc.addPage();
      doc.setFillColor(30, 41, 59); doc.rect(0, 0, pageWidth, 35, 'F');
      doc.setTextColor(255, 255, 255); doc.text("Informe de Gestión Turística", 14, 22);
      const canvasMuseos = document.getElementById('chart-museos') as HTMLCanvasElement;
      doc.addImage(canvasMuseos.toDataURL('image/png'), 'PNG', 55, 45, 100, 80);

      autoTable(doc, {
        startY: 130,
        head: [['Fecha', 'Museo', 'Locales', 'Nacionales', 'Extranjeros', 'Total']],
        body: currentDataMuseos.map(r => [new Date(r.fecha_reporte).toLocaleDateString(), r.entidades.nombre, clean(r.visitantes_locales), clean(r.visitantes_nacionales), clean(r.visitantes_extranjeros), clean(r.total_visitantes)]),
        headStyles: { fillColor: [249, 115, 22] }
      });

      doc.save("Reporte_Turismo_Oficial.pdf");
    } catch (err) { console.error(err); alert("Error al generar PDF"); } 
    finally { btn.textContent = "DESCARGAR INFORME PDF"; btn.disabled = false; }
  }

  async function cargarDatosHotel(id = null) {
    let q = supabase.from('reportes_hoteleria').select('*, entidades(nombre)').order('fecha_reporte', { ascending: false });
    if (id) q = q.eq('entidad_id', id);
    const { data } = await q;
    if (data) {
      currentDataHoteles = data;
      document.getElementById('tabla-hoteles')!.innerHTML = data.map(r => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-4">${new Date(r.fecha_reporte).toLocaleDateString()}</td>
          <td class="px-4 py-4 font-medium">${r.entidades.nombre}</td>
          <td class="px-4 py-4">${clean(r.total_huespedes)}</td>
          <td class="px-4 py-4">${clean(r.habitaciones_ocupadas)}</td>
          <td class="px-4 py-4">${clean(r.total_habitaciones - r.habitaciones_ocupadas)}</td>
          <td class="px-4 py-4 text-right"><button onclick="confirmarEliminacion('${r.id}', 'reportes_hoteleria')" class="text-red-500 font-bold">Borrar</button></td>
        </tr>`).join('');
      if (userProfile.rol === 'admin_gobierno') renderChartHoteles(data);
    }
  }

  async function cargarDatosMuseo(id = null) {
    let q = supabase.from('reportes_museos').select('*, entidades(nombre)').order('fecha_reporte', { ascending: false });
    if (id) q = q.eq('entidad_id', id);
    const { data } = await q;
    if (data) {
      currentDataMuseos = data;
      document.getElementById('tabla-museos')!.innerHTML = data.map(r => `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-4">${new Date(r.fecha_reporte).toLocaleDateString()}</td>
          <td class="px-4 py-4 font-medium">${r.entidades.nombre}</td>
          <td class="px-4 py-4">${clean(r.visitantes_locales)}</td>
          <td class="px-4 py-4">${clean(r.visitantes_nacionales)}</td>
          <td class="px-4 py-4">${clean(r.visitantes_internacionales)}</td>
          <td class="px-4 py-4 font-bold text-orange-600">${clean(r.total_visitantes)}</td>
          <td class="px-4 py-4 text-right"><button onclick="confirmarEliminacion('${r.id}', 'reportes_museos')" class="text-red-500 font-bold">Borrar</button></td>
        </tr>`).join('');
      if (userProfile.rol === 'admin_gobierno') renderChartMuseos(data);
    }
  }

  function cargarTodo() { cargarDatosHotel(); cargarDatosMuseo(); }

  (window as any).confirmarEliminacion = async (id: string, tabla: string) => {
    if (!confirm("¿Deseas eliminar este registro?")) return;
    const { error } = await supabase.from(tabla).delete().eq('id', id);
    if (!error) { alert("Registro eliminado"); cargarTodo(); }
  };
  // --- LÓGICA DE FILTROS ---
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      // 1. Gestionar estados visuales de los botones
      document.querySelectorAll('.filter-btn').forEach(b => {
        b.classList.remove('bg-slate-900', 'text-white', 'active');
        b.classList.add('bg-white', 'text-slate-600', 'border');
      });
      btn.classList.add('bg-slate-900', 'text-white', 'active');
      btn.classList.remove('bg-white', 'text-slate-600', 'border');

      // 2. Filtrar las secciones
      const filter = btn.getAttribute('data-filter');
      const containerHoteles = document.getElementById('container-hoteles');
      const containerMuseos = document.getElementById('container-museos');
      const chartSection = document.getElementById('admin-charts');

      if (filter === 'todos') {
        containerHoteles?.classList.remove('hidden');
        containerMuseos?.classList.remove('hidden');
        chartSection?.classList.remove('hidden');
      } else if (filter === 'hotel') {
        containerHoteles?.classList.remove('hidden');
        containerMuseos?.classList.add('hidden');
        // Opcional: mostrar solo gráfico de hoteles si quieres
      } else if (filter === 'museo') {
        containerHoteles?.classList.add('hidden');
        containerMuseos?.classList.remove('hidden');
      }
    });
  });

  initDashboard();
</script>